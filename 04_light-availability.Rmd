---
editor_options: 
  chunk_output_type: console
---

# Light availability

In this script, we examine differences in vocal activity between dawn and dusk as a function of light availability. The expectation is that species would call much earlier in the day, closer to sunrise compared to later in the day when one could spend time foraging.  

## Install necessary libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(ggstatsplot)
library(suncalc)
library(lutz)
library(stringr)
library(ggpmisc)
library(ggpubr)
library(hms)
```

## Load acoustic data and species scientific names data
```{r}
acoustic_data <- read.csv("results/acoustic_data.csv")
sites <- read.csv("data/list-of-sites.csv")
species_codes <- read.csv("data/species-annotation-codes.csv")
```

## Remove species with very few total detections across dawn and dusk  

We create a filter to remove species that had very few total detections at dawn and dusk. 
```{r}
spp_subset <- acoustic_data %>%
  group_by(time_of_day, eBird_codes) %>%
  summarise(detections = sum(number)) %>%
  left_join(., species_codes[,c(1,2,5)], 
                       by = "eBird_codes") %>%
   group_by(eBird_codes) %>%
  mutate(total_detections =sum(detections)) %>%
  ungroup()

# for further analysis, we remove species that were detected less than 20 times cumulatively across dawn and dusk
# this ensures that we keep species that called very few times in the morning and perhaps more times in the evening, or vice-versa

spp_subset <- spp_subset %>%
  filter(total_detections > 20) 

# subset data
acoustic_data <- acoustic_data %>%
  filter(eBird_codes %in% spp_subset$eBird_codes)
```

## Extract light availability for each date
```{r}
# add longitude and latitude to acoustic_data
acoustic_data <- left_join(acoustic_data, sites[,c(2,4,5)],
                   by = "site_id") 
acoustic_data$date <- lubridate::ymd(acoustic_data$date)
names(acoustic_data)[c(10,11)] <- c("lon","lat")

# find out what time zone needs to be provided for the sunlight calculations
acoustic_data$tz <- tz_lookup_coords(lat = acoustic_data$lat,
                                     lon = acoustic_data$lon,
                                     method = "accurate",
                                     warn = FALSE)

# extract nauticalDawn, nauticalDusk, sunrise and sunset times
light_data <- getSunlightTimes(data = acoustic_data,
                          keep = c("sunrise","sunset",
                                   "nauticalDawn", "nauticalDusk"),
                          tz = "Asia/Kolkata") %>% distinct(.)

# strip dates from new columms and keep only time
light_data$sunrise <- as_hms(light_data$sunrise)
light_data$sunset <- as_hms(light_data$sunset)
light_data$nauticalDawn <- as_hms(light_data$nauticalDawn)
light_data$nauticalDusk <- as_hms(light_data$nauticalDusk)

# format the start_time column in the acoustic data to keep it as the same format as light_data
acoustic_data <- acoustic_data %>%
   mutate(across(start_time, str_pad, width = 6, pad = "0"))
acoustic_data$start_time<- format(strptime(acoustic_data$start_time, 
                         format = "%H%M%S"), format = "%H:%M:%S")
acoustic_data$start_time <- as_hms(acoustic_data$start_time)

# summarize detections of species for every 15-min window
acoustic_data <- acoustic_data %>%
  group_by(site_id, date, start_time, time_of_day, eBird_codes,
           lon, lat) %>%
  summarise(detections = sum(number)) %>%
  ungroup()

# join the two datasets
acoustic_data <- left_join(acoustic_data, light_data,
                   by = c("date","lon","lat"))

# subtract times from sunrise, sunset, nauticalDawn and nauticalDusk from start_time of acoustic detections
acoustic_data <- acoustic_data %>%
  mutate(time_from_dawn = as.numeric((start_time - nauticalDawn), 
                                     units = "hours")) %>%
  mutate(time_from_sunrise = as.numeric((start_time - sunrise), 
                                     units = "hours")) %>%
  mutate(time_to_dusk = as.numeric((nauticalDusk-start_time), 
                                     units = "hours")) %>%
  mutate(time_to_sunset = as.numeric((sunset-start_time), 
                                     units = "hours"))
```

## Model acoustic detections as a function of light availability  

Here, we choose times of day as proxies for light availability (ie. nautical dawn, dusk for example).  

```{r}
# Here, we make the assumption that light levels are fairly similar closer to dawn and closer to dusk. Hence, we model the number of acoustic detections as a function of time to dusk and time from dawn. 

# add species_codes/common_name to the above dataset
acoustic_data <- acoustic_data %>%
  left_join(., species_codes[,c(1,2,5)], 
                       by = "eBird_codes") %>% 
  ungroup()

# visualization
plots <- list()

for(i in 1:length(unique(acoustic_data$common_name))) {
  
  #
}

sp1 <- acoustic_data %>%
  filter(eBird_codes == "crbsun2")

dawn <- sp1 %>%
  filter(time_of_day == "dawn") %>%
  dplyr::select(detections, time_from_dawn, time_of_day) %>%
  rename(., time_from_startTime = time_from_dawn)

dusk <- sp1 %>%
  filter(time_of_day == "dusk") %>%
  dplyr::select(detections, time_to_dusk, time_of_day) %>%
  rename(., time_from_startTime = time_to_dusk)

data <- bind_rows(dawn, dusk)

trial <- ggplot(data, aes(x= time_from_startTime,
                y= detections,
                fill = time_of_day)) +
  geom_point(shape = 21, aes(fill = time_of_day), 
            size = 2, stroke = 1, alpha = 0.7)+ 
  geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid", aes(color = time_of_day)) +
  scale_fill_manual(values = c("#d95f02","#1b9e77"))+
  scale_color_manual(values = c("#d95f02","#1b9e77")) +
  theme_bw() +
  labs(title = "Crimson-backed sunbird",
       subtitle = "Each dot represents the total number of detections after dawn or before dusk (in hours)",
    y="\n Number of acoustic detections", 
       x="Time from Dawn and time to dusk (in hours)\n") + 
  theme(text = element_text(family = "Century Gothic", size = 18, face = "bold"),plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
      plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "italic",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"))


metadata <- data.frame()

for(i in 1:length(unique(dat_subset$scientific_name))){
  
  # extract species scientific name
  a <- unique(dat_subset$scientific_name)[i]
  
  # subset data for plotting
  for_plot <- dat_subset[dat_subset$scientific_name==a,]
  
  # create plots
  plots[[i]] <- ggscatterstats(
  data = for_plot,
  x = detections_aru,
  y = abundance_pc,
  type = "r",
  title = a,
  ggplot.component = list(theme(text = element_text(family = "Century Gothic", size = 15, face = "bold"),plot.title = element_text(family = "Century Gothic",size = 18, face = "bold"),
    plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "bold",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 15, face = "bold"))))
  
  # write the metadata to a dataframe for later analysis
  # extracting information using a pre-existing function
  stat <- extract_stats(plots[[i]])$subtitle_data
  stat$scientific_name <- a
  
  # add it to the above empty metadata dataframe
  metadata <- rbind(metadata, stat)
}

# plot and save as a single pdf
cairo_pdf(
  filename = "figs/abundance-detections-by-species-correlations.pdf",
  width = 13, height = 12,
  onefile = TRUE
)
plots
dev.off()


```


