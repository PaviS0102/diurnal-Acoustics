---
editor_options: 
  chunk_output_type: console
---

# Light availability

In this script, we examine differences in vocal activity between dawn and dusk as a function of light availability. The expectation is that species would call much earlier in the day, closer to sunrise compared to later in the day when one could spend time foraging.  

## Install necessary libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(ggstatsplot)
library(suncalc)
library(lutz)
library(stringr)
library(ggpmisc)
library(ggpubr)
library(hms)
library(RColorBrewer)
```

## Load acoustic data and species scientific names data
```{r}
acoustic_data <- read.csv("results/acoustic_data.csv")
sites <- read.csv("data/list-of-sites.csv")
species_codes <- read.csv("data/species-annotation-codes.csv")
```


## Extract light availability for each date
```{r}
# add longitude and latitude to acoustic_data
acoustic_data <- left_join(acoustic_data, sites[,c(2,4,5)],
                   by = "site_id") 
acoustic_data$date <- lubridate::ymd(acoustic_data$date)
names(acoustic_data)[c(10,11)] <- c("lon","lat")

# find out what time zone needs to be provided for the sunlight calculations
acoustic_data$tz <- tz_lookup_coords(lat = acoustic_data$lat,
                                     lon = acoustic_data$lon,
                                     method = "accurate",
                                     warn = FALSE)

# extract nauticalDawn, nauticalDusk, sunrise and sunset times
light_data <- getSunlightTimes(data = acoustic_data,
                          keep = c("sunrise","sunset",
                                   "nauticalDawn", "nauticalDusk"),
                          tz = "Asia/Kolkata") %>% distinct(.)

# strip dates from new columms and keep only time
light_data$sunrise <- as_hms(light_data$sunrise)
light_data$sunset <- as_hms(light_data$sunset)
light_data$nauticalDawn <- as_hms(light_data$nauticalDawn)
light_data$nauticalDusk <- as_hms(light_data$nauticalDusk)

# format the start_time column in the acoustic data to keep it as the same format as light_data
acoustic_data <- acoustic_data %>%
   mutate(across(start_time, str_pad, width = 6, pad = "0"))
acoustic_data$start_time<- format(strptime(acoustic_data$start_time, 
                         format = "%H%M%S"), format = "%H:%M:%S")
acoustic_data$start_time <- as_hms(acoustic_data$start_time)

# summarize detections of species for every 15-min window
acoustic_data <- acoustic_data %>%
  group_by(site_id, date, start_time, time_of_day, eBird_codes,
           lon, lat, hour_of_day) %>%
  summarise(detections = sum(number)) %>%
  ungroup()

# join the two datasets
acoustic_data <- left_join(acoustic_data, light_data,
                   by = c("date","lon","lat"))

# subtract times from sunrise, sunset, nauticalDawn and nauticalDusk from start_time of acoustic detections
acoustic_data <- acoustic_data %>%
  mutate(time_from_dawn = as.numeric((start_time - nauticalDawn), 
                                     units = "hours")) %>%
  mutate(time_from_sunrise = as.numeric((start_time - sunrise), 
                                     units = "hours")) %>%
  mutate(time_to_dusk = as.numeric((nauticalDusk-start_time), 
                                     units = "hours")) %>%
  mutate(time_to_sunset = as.numeric((sunset-start_time), 
                                     units = "hours"))
```

## Model acoustic detections as a function of light availability  

Here, we choose times of day as proxies for light availability (ie. nautical dawn, dusk for example).  

```{r}
# Here, we make the assumption that light levels are fairly similar closer to dawn and closer to dusk. Hence, we model the number of acoustic detections as a function of time to dusk and time from dawn. 

# add species_codes/common_name to the above dataset
acoustic_data <- acoustic_data %>%
  left_join(., species_codes[,c(1,2,5)], 
                       by = "eBird_codes") %>% 
  ungroup()

# visualization
plots <- list()

# collect slope and other coefficient information here
metadata <- c()

for(i in 1:length(unique(acoustic_data$common_name))) {
  
  # extract species common_name
  a <- unique(acoustic_data$common_name)[i]
  
  # subset data for plotting
  sp <- acoustic_data[acoustic_data$common_name==a,]
  
  # bind dawn and dusk data together
  dawn <- sp %>%
  filter(time_of_day == "dawn") %>%
  dplyr::select(detections, time_from_dawn, time_of_day) %>%
  rename(., time_from_startTime = time_from_dawn)
  
  dusk <- sp %>%
  filter(time_of_day == "dusk") %>%
  dplyr::select(detections, time_to_dusk, time_of_day) %>%
  rename(., time_from_startTime = time_to_dusk)
  
  data <- bind_rows(dawn, dusk)
  
  plots[[i]] <- ggplot(data, aes(x= time_from_startTime,
                y= detections,
                fill = time_of_day)) +
  geom_point(shape = 21, aes(fill = time_of_day), 
            size = 2, stroke = 1, alpha = 0.7)+ 
  geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid", aes(color = time_of_day)) +
  scale_fill_manual(values = c("#d95f02","#1b9e77"))+
  scale_color_manual(values = c("#d95f02","#1b9e77")) +
  theme_bw() +
  labs(title = a,
       subtitle = "Each dot represents the total number of detections after dawn or before dusk (in hours)",
    y="\n Number of acoustic detections", 
       x="Time to darkness\n") + 
  theme(text = element_text(family = "Century Gothic", size = 18, face = "bold"),plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
      plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "italic",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"))
  
  # collect metadata
  data <- setDT(data)
  
  # extract t-value
  data[,  t_value := summary(lm(detections ~    time_from_startTime))$coefficients[6], by = time_of_day] 
  
  # extract slope
  data[,  slope := lm(detections ~ time_from_startTime) %>% 
         coef()%>% nth(2), by = time_of_day] 

  # extract adjusted r squared
  data[,  r_sq := summary(lm(detections ~ time_from_startTime))$adj.r.squared,    by = time_of_day]
  
  # create a column with the direction of the slope (whether it is positive or    negative)  
  data[, slope_dir := ifelse(slope >0, '+', '-')]

  # extract distinct values of coefficients for each species
  lm_output <- data %>%
  dplyr::select(time_of_day, t_value, slope, slope_dir,r_sq) %>% 
    distinct() %>%
    mutate(common_name = a)
  
  ## add the above to the metadata object
  metadata <- bind_rows(metadata, lm_output)
}

# save as a single pdf
cairo_pdf(
  filename = "figs/light-availability-acoustic-detections-by-species.pdf",
  width = 13, height = 12,
  onefile = TRUE
)
plots
dev.off()

# write metadata to file
write.csv(metadata, "results/slopes-detections-lightAvailability.csv",
          row.names = F)
```

## Paired statistical test to assess if the slopes (of detections ~ timing of vocalization) are significantly different between dawn and dusk across species

```{r}
stat.test <- metadata %>%
  filter(common_name != "White-throated Kingfisher") %>%
  filter(common_name != "Oriental-Magpie Robin") %>%
  filter(common_name != "Malabar Trogon") %>%
  filter(common_name != "Gray-headed Canary-Flycatcher") %>%
  pairwise_wilcox_test(slope ~ time_of_day)

# No significant differences were observed between the slopes across dawn and dusk. Here the slope conveys teh relationship between the number of acoustic detections and timing of vocalization

# A tibble: 1 Ã— 9
#  .y.   group1 group2    n1    n2 statistic     p p.adj p.adj.signif
#* <chr> <chr>  <chr>  <int> <int>     <dbl> <dbl> <dbl> <chr>       
#1 slope dawn   dusk      66    63      1885 0.362 0.362 ns 
```

## Visualization of timing of vocalization 

```{r}
# visualization
plots <- list()

for(i in 1:length(unique(acoustic_data$common_name))) {
  
  # extract species common_name
  a <- unique(acoustic_data$common_name)[i]
  
  # subset data for plotting
  sp <- acoustic_data[acoustic_data$common_name==a,] %>%
    group_by(hour_of_day) %>%
    summarise(detections = sum(detections)) %>%
    mutate(total_detections =sum(detections)) %>%
    mutate(percent_detections = (detections/total_detections)*100) %>%
    ungroup() 
  
  # add a break/no data for mid-day
  sp <- sp %>%
    add_row(hour_of_day = "Mid-day",
            detections = 0,
            total_detections = 0,
            percent_detections = 0)
  
  # reordering factors for plotting
  sp$hour_of_day <- factor(sp$hour_of_day, levels = c("6AM to 7AM", 
                                                      "7AM to 8AM", 
                                                      "8AM to 9AM",
                                                      "9AM to 10AM",
                                                      "Mid-day",
                                                      "4PM to 5PM",
                                                      "5PM to 6PM",
                                                      "6PM to 7PM"))

  plots[[i]] <- ggplot(sp, aes(x=hour_of_day, 
                        y=percent_detections)) +  
  geom_bar(stat = "identity", position = position_dodge(), 
           fill = "#883107", alpha = 0.9) + 
  geom_text(aes(label = ifelse(percent_detections > 0,
                               round(percent_detections, 2), ""),
                hjust = "middle", vjust = -0.5, family = "Century Gothic"),
    position = position_dodge(), angle = 0, size = 5) +
    theme_bw() +
    labs(title = a,
       subtitle = "Each bar represents the % of detections across dawn and dusk",
    y="\n % Acoustic detections", 
       x="Time of Day\n") +
  theme(text = element_text(family = "Century Gothic", size = 18, face = "bold"),plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
      plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "italic",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"))
}

# save as a single pdf
cairo_pdf(
  filename = "figs/acoustic-detections-time-of-day-by-species.pdf",
  width = 13, height = 12,
  onefile = TRUE
)
plots
dev.off()
```


