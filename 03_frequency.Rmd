---
editor_options: 
  chunk_output_type: console
---

# Frequency

In this script, we examine differences in vocal activity between dawn and dusk for each species as a function of frequency. The expectation is that higher frequency vocalizers would call more at dawn compared to dusk, owing to better signal transmission in the morning.

## Install necessary libraries
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(ggplot2)
library(scico)
library(data.table)
library(extrafont)
library(ggstatsplot)
library(ggpubr)
library(ggrepel)
```

## Load acoustic data and species scientific names data
```{r}
acoustic_data <- read.csv("results/acoustic_data.csv")
species_codes <- read.csv("data/species-annotation-codes.csv")
freq <- read.csv("data/frequency-data.csv")
```

## Vocal activity data
```{r}
# sampling effort by time_of_day
effort <- acoustic_data %>%
    dplyr::select(site_id, date, time_of_day) %>%
    distinct() %>%
    arrange(time_of_day) %>%
    count(time_of_day) %>%
    rename(., nVisits = n)

# total number of acoustic detections summarized across every 10-s audio file
# here, we estimate % detections at dawn and dusk, while accounting for sampling effort
vocal_act <- acoustic_data %>%
  group_by(time_of_day, eBird_codes) %>%
  summarise(detections = sum(number)) %>%
  left_join(., species_codes[,c(1,2,5)], 
                       by = "eBird_codes") %>%
   group_by(eBird_codes) %>%
  mutate(total_detections =sum(detections)) %>%
  mutate(percent_detections = (detections/total_detections)*100) %>%
  ungroup() 

## accouting for sampling effort and normalizing data
vocal_act <- vocal_act %>%
  left_join(., effort, by = "time_of_day") %>%
  mutate(normalized_detections = detections/nVisits) %>%
  group_by(eBird_codes) %>%
  mutate(total_normalized_detections = sum(normalized_detections)) %>%
  mutate(percent_normalized_detections = (normalized_detections/total_normalized_detections)*100) %>%
  ungroup()
```

## Frequency data

We will extract the median peak frequency for each species. Note: For a total of 114 species, template recordings (varying from a minimum of 2 templates to 1910 templates per species) was extracted by Meghana P Srivathsa. While extracting median peak frequency, no distinction was made between songs and calls. We removed species that had very few templates (we only kept species that had a minimum of five frequency related measures).

```{r}
# add standardized eBird codes to the frequency data
freq <-left_join (freq, species_codes[c(3,5)],
                  by = "species_annotation_codes")

# Only a total of 99 species are left after filtering species with very few templates
nTemplates_5 <- freq %>%
  group_by(eBird_codes) %>%
  count() %>%
  filter(n >= 5) %>%
  drop_na()

# left-join to remove species with less than five templates in the frequency dataset
freq_5 <- left_join(nTemplates_5[,1], freq)

# calculate median peak frequency
median_pf <- freq_5 %>%
  group_by(eBird_codes) %>%
  summarise(median_peak_freq =  median(peak_freq_in_Hz))

## join the frequency data to the vocal activity data
voc_freq <- left_join(vocal_act, median_pf, by = "eBird_codes") %>%
  drop_na()

# A total of 66 species were included and three species were excluded due to lack of data. 
```

## Visualization of % detections vs. median peak frequency

Here, we model the % of detections at dawn as a function of median peak frequency.  

```{r}
# we will filter the data to only include dawn
dawn <- voc_freq %>%
  mutate(log_freq = log10(median_peak_freq)) %>%
  filter(time_of_day == "dawn") 

# the only species that was excluded above was pied bushchat, which was reported only from dusk

fig_freq_vocAct <- ggplot(dawn, aes(x=log_freq,
                                        y= percent_normalized_detections)) +
  geom_point(shape = 21, colour = "black", 
             fill = "white", size = 2, stroke = 1)+ 
  geom_smooth(method="lm", se=TRUE, fullrange=FALSE, level=0.95,linetype="solid") +  
  theme_bw() +
  stat_regline_equation(label.x = 2.4, aes(label = ..eq.label..),
                        label.y = 25, size = 6,
                        family = "Century Gothic") +
  stat_regline_equation(label.x = 2.4, aes(label = ..rr.label..),
                        label.y = 20,
                        size = 6,
                        family = "Century Gothic") +
  labs(y="\n % Vocal activity at Dawn", 
       x=" log (Median Peak Frequency)\n") +
  geom_text_repel(aes(label = common_name), family = "Century Gothic",
                  fontface = "italic") +
  theme(text = element_text(family = "Century Gothic", size = 18, face = "bold"),plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
      plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "bold",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"))

ggsave(fig_freq_vocAct, filename = "figs/fig_peakFrequency_vs_dawnDetections.png", width = 14, height = 16, device = png(), units = "in", dpi = 300)
dev.off() 
```

```{r, echo = FALSE, fig.cap= "No significant relationship was observed between % acoustic detections at dawn and median peak frequency."}
knitr::include_graphics("figs/fig_peakFrequency_vs_dawnDetections.png")
```
